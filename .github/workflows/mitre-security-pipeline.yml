name: Reusable SBOM & Vulnerability Gates for all projects & Env

on:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
      image_name:
        required: true
        type: string
    secrets:
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      SLACK_WEBHOOK_URL:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine environment
        id: set-env
        run: |
          if [[ -n "${{ inputs.environment }}" ]]; then
            echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == "refs/heads/main" ]] || [[ "${GITHUB_REF}" =~ refs/tags/v.* ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
          echo "Determined environment: $ENVIRONMENT"

      - name: Set severity thresholds
        id: thresholds
        run: |
          case "$ENVIRONMENT" in
            prod)
              echo "ALLOWED_SEVERITY=LOW,MEDIUM" >> $GITHUB_ENV
              echo "DENY_SEVERITY=HIGH,CRITICAL" >> $GITHUB_ENV
              ;;
            staging)
              echo "ALLOWED_SEVERITY=LOW,MEDIUM,HIGH" >> $GITHUB_ENV
              echo "DENY_SEVERITY=CRITICAL" >> $GITHUB_ENV
              ;;
            dev|*)
              echo "ALLOWED_SEVERITY=ALL" >> $GITHUB_ENV
              echo "DENY_SEVERITY=" >> $GITHUB_ENV
              ;;
          esac

      - uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        run: |
          docker build --build-arg BUILDKIT_INLINE_CACHE=1 \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new \
            -t "${{ inputs.image_name }}:${GITHUB_SHA}" .
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ inputs.image_name }}:${GITHUB_SHA}"
          format: sarif
          output: trivy.sarif
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy.sarif

      - name: Generate SBOM (CycloneDX)
        run: |
          trivy image --format cyclonedx \
            --output sbom.json "${{ inputs.image_name }}:${GITHUB_SHA}"

      - name: SBOM vulnerability scan
        run: |
          trivy sbom sbom.json --format json \
            --output vuln-report.json \
            --severity CRITICAL,HIGH,MEDIUM,LOW

      - name: MITRE analysis
        run: |
          python3 scripts/mitre_analyzer.py \
            --input vuln-report.json \
            --output mitre-analysis.json \
            --environment "${ENVIRONMENT}"

      - name: OPA policy enforcement
        id: opa
        run: |
          conftest test vuln-report.json \
            --policy policy/ \
            --data exceptions/ \
            --set deny_severity="${DENY_SEVERITY}" \
            --set allowed_severity="${ALLOWED_SEVERITY}" || exit 1
          conftest test sbom.json --policy policy/ || exit 1
          conftest test mitre-analysis.json --policy policy/ || exit 1

      - name: Compliance annotations (SLSA/NIST/ISO)
        run: |
          python3 scripts/compliance_mapper.py \
            --input vuln-report.json \
            --output compliance-report.json \
            --frameworks SLSA,NIST800-53,ISO27001

      - name: Upload security artifacts
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            sbom.json
            vuln-report.json
            mitre-analysis.json
            trivy.sarif
            compliance-report.json

      - name: Archive security artifacts to S3
        if: ${{ always() }}
        env:
          S3_BUCKET: my-enterprise-sbom-bucket
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          for file in sbom.json vuln-report.json mitre-analysis.json compliance-report.json trivy.sarif; do
            if [ -f "$file" ]; then
              aws s3 cp "$file" "s3://${S3_BUCKET}/${GITHUB_REPOSITORY}/${GITHUB_SHA}/$file"
            fi
          done

      - name: Push metrics to CloudWatch
        run: |
          python3 scripts/cloudwatch_metrics.py \
            --vuln-report vuln-report.json \
            --mitre-report mitre-analysis.json
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Notify Slack on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        with:
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: "Security gates failed in $ENVIRONMENT for image ${{ inputs.image_name }}:${GITHUB_SHA}"
          color: danger
