name: Reusable SBOM & Vulnerability Gates

# Reusable workflow definition
on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_name:
        required: true
        type: string
    secrets:
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      SLACK_WEBHOOK_URL:
        required: true

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env
        run: |
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${{ inputs.image_name }}" >> $GITHUB_ENV

      - name: Set severity thresholds by environment
        id: thresholds
        run: |
          if [[ "${ENVIRONMENT}" == "prod" ]]; then
            echo "ALLOWED_SEVERITY=LOW,MEDIUM" >> $GITHUB_ENV
            echo "DENY_SEVERITY=HIGH,CRITICAL" >> $GITHUB_ENV
          elif [[ "${ENVIRONMENT}" == "staging" ]]; then
            echo "ALLOWED_SEVERITY=LOW,MEDIUM,HIGH" >> $GITHUB_ENV
            echo "DENY_SEVERITY=CRITICAL" >> $GITHUB_ENV
          else
            # dev or nonprod
            echo "ALLOWED_SEVERITY=ALL" >> $GITHUB_ENV
            echo "DENY_SEVERITY=" >> $GITHUB_ENV
          fi

      - uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t "${IMAGE_NAME}:${GITHUB_SHA}" .

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${IMAGE_NAME}:${GITHUB_SHA}"
          format: sarif
          output: trivy.sarif
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy.sarif

      - name: Generate SBOM (CycloneDX)
        run: |
          trivy image --format cyclonedx \
            --output sbom.json "${IMAGE_NAME}:${GITHUB_SHA}"

      - name: SBOM vulnerability scan
        run: |
          trivy sbom sbom.json --format json \
            --output vuln-report.json \
            --severity CRITICAL,HIGH,MEDIUM,LOW

      - name: MITRE analysis
        run: |
          python3 scripts/mitre_analyzer.py \
            --input vuln-report.json \
            --output mitre-analysis.json \
            --environment "${ENVIRONMENT}"

      - name: OPA policy enforcement
        run: |
          # Enforce environment-aware gates
          conftest test vuln-report.json \
            --policy policy/ \
            --data exceptions/ \
            --set deny_severity="${DENY_SEVERITY}" \
            --set allowed_severity="${ALLOWED_SEVERITY}"

          conftest test sbom.json --policy policy/
          conftest test mitre-analysis.json --policy policy/

      - name: Compliance annotations (SLSA/NIST/ISO)
        run: |
          python3 scripts/compliance_mapper.py \
            --input vuln-report.json \
            --output compliance-report.json \
            --frameworks SLSA,NIST800-53,ISO27001

      - name: Upload security artifacts
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            sbom.json
            vuln-report.json
            mitre-analysis.json
            trivy.sarif
            compliance-report.json
