package security.vulnerabilities

import data.security.metadata
import data.exceptions

default deny = []

# Deny if severity is in workflow-provided deny list and not an exception
deny[msg] {
    some v
    v := input.Results[_].Vulnerabilities[_]

    not allowed_exception(v)

    contains(input.deny_severity, v.Severity)

    msg := sprintf(
        "[Policy %s][%s] Vulnerability %s in %s blocked by policy",
        [metadata.policy_version, input.environment, v.VulnerabilityID, v.PkgName]
    )
}

# Helper: allowed exception
allowed_exception(v) {
    some e
    e := exceptions.exceptions[_]
    e.vulnerability_id == v.VulnerabilityID
    e.expires_at > time.now_ns()
}

# Helper: check if value is in comma-separated list
contains(list, val) {
    val == split(list, ",")[_]
}
